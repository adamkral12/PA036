config:
  # This structure should hold queries with same meaning

  # VALIDATED - same
  - sql: SELECT mix, a.events->0 as events, a.ids as ids, a.count as countids FROM (select concat(data->>'from',';',data->>'to') as mix, json_agg(data->'events') as events, count(*) as count, json_agg(data->'id') as ids from emails_with_events group by mix having count(*)=2) as a
    mongo:
      method: AGGREGATE
      query:
        # this query is so slow
        # filter: '[{"$lookup": {"from":"emails","localField":"from","foreignField":"from","as":"joined"}}, {"$unwind": "$joined"}, {"$project": {"id":1, "joined.id":1, "joined.events":1, "events":1, "from":1, "joined.from":1, "to":1, "joined.to":1, "eqTo": {"$eq":["$to", "$joined.to"]}, "eqId": {"$eq":["$id", "$joined.id"]}}}, {"$match": {"eqTo":true, "eqId":false}}, {"$project":{"id":1, "from":1, "to":1, "other_id":"$joined.id", "other_from":"$joined.from", "other_to":"$joined.to", "events":{"$concatArrays":["$events", "$joined.events"]}}}]'
        # updated query but does not return same result as sql
        filter: '[{"$addFields":{"fromto": {"$concat":["from:", "$from", ";to:", "$to"]}}},{"$group":{"_id": "$fromto", "events": {"$push": "$events"}, "ids": {"$push": "$id"}, "countids": {"$sum":1}}}, {"$match":{"countids":{"$gt":1}}}]'
    description: "Join events where from and to emails match"

  # VALIDATED -same
  - sql: SELECT id, device, count(singleevent) as events FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'user_agent' ->> 'platform' as device FROM emails_with_events) as eventarray  GROUP BY id, device
    mongo:
      method: AGGREGATE
      query:
        filter: '[{"$unwind":"$events"}, {"$group":{"_id": {"id":"$id", "device":"$events.user_agent.platform"}, "events":{"$sum":1}}}]'
    description: "Count events for email by device"

  # VALIDATED - same
  - sql: SELECT * FROM (SELECT id, max(longitude::decimal) as singlemax FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'position' -> 'geographical' ->> 'long' as longitude FROM emails_with_events) as eventarray  GROUP BY id) maxwithid WHERE singlemax=(SELECT max(longitude::decimal) FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'position' -> 'geographical' ->> 'long' as longitude FROM emails_with_events) as localmax)
    mongo:
      method: AGGREGATE
      query:
        filter: '[{"$unwind":"$events"}, {"$match":{"events.position.geographical.long":{"$ne": null}}}, {"$sort": {"events.position.geographical.long":-1}}, {"$limit":1}, {"$project":{"id":1, "max_longitude":"$events.position.geographical.long"}}]'
    description: "Select email with max longitude event"

  # VALIDATED - same
  - sql: SELECT * FROM (SELECT id, min(latitude::decimal) as singlemin FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'position' -> 'geographical' ->> 'lat' as latitude FROM emails_with_events) as eventarray  GROUP BY id) maxwithid WHERE singlemin=(SELECT min(latitude::decimal) FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'position' -> 'geographical' ->> 'lat' as latitude FROM emails_with_events) as localmax)
    mongo:
      method: AGGREGATE
      query:
        filter: '[{"$unwind":"$events"}, {"$match":{"events.position.geographical.lat":{"$ne": null}}}, {"$sort": {"events.position.geographical.lat":1}}, {"$limit":1}, {"$project":{"id":1, "min_latitude":"$events.position.geographical.lat"}}]'
    description: "Select email with min latitude event"

  # VALIDATED - same
  - sql: SELECT count(*) FROM emails_with_events WHERE id in (SELECT id FROM emails_with_events WHERE (data -> 'sent')::jsonb ? 'timezone'::text)
    mongo:
      method: AGGREGATE
      query:
        filter: '[{"$match":{"sent.timezone":{"$ne": null}}}, {"$count":"count"}]'
    description: "Count emails where timezone exists in sent"

  # VALIDATED - same
  - sql: SELECT count(*) FROM emails_with_events WHERE id in (SELECT DISTINCT id FROM (SELECT id, json_array_elements(data -> 'events') -> 'position' as position FROM emails_with_events) as events WHERE position::jsonb ? 'timezone'::text)
    mongo:
      method: AGGREGATE
      query:
        filter: '[{"$match":{"events": {"$elemMatch": { "position.timezone": { "$ne": null } }}}}, {"$count":"count"}]'
    description: "Count emails where timezone exists in position of event"


  # VALIDATED - same
  - sql: INSERT INTO emails_with_events(id, data) VALUES ('0', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}')
    mongo:
      method: INSERT_ONE
      query:
       value: '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}'
    description: "Insert one email"

  # VALIDATED - same
  - sql: INSERT INTO emails_with_events(id, data) VALUES ('11', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}'), ('1', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}'), ('2', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}'), ('3', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}'), ('4', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}'), ('5', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}'), ('6', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}'), ('7', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}'), ('8', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}'), ('9', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}'), ('10', '{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}')
    mongo:
      method: INSERT_MANY
      query:
        value: '[{"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}],"id":"c0b7a14f34d345eda2666d5159c288de"}, {"from":"test@test.com","to":"madmike272@hotmail.com","sent":{"date":"2018-08-01 08:00:00.000000","timezone_type":1,"timezone":"+02:00"},"type":"upcoming_journey","events":[{"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b7a14f34d345eda2666d5159c288de"}, {"event_type":"delivery","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"c0b74f34d345eda2666d5159c288de"}],"id":"c0b74f34d345eda2666d5159c288de"}]'
    description: "Insert 11 emails, 1 or 2 events each"

  # VALIDATED - same
  - sql: UPDATE emails_with_events SET data = jsonb_insert(data::jsonb, '{events, 0}'::text[], jsonb '{"event_type":"test","user_agent":{"browser":null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"test"}') WHERE (data ->> 'type') = 'verify_email'
    mongo:
      method: UPDATE_MANY
      query:
        filter: '{"type": "verify_email"}'
        value:  '{"$push": {"events": {"event_type":"test","user_agent":{"browser": null,"platform":null},"position":{"country":null,"city":null,"geographical":{"lat":null,"long":null}},"received":{"date":"2018-08-01 08:04:27.000000","timezone_type":1,"timezone":"+02:00"},"occurred":{"date":"2018-08-01 07:59:59.000000","timezone_type":1,"timezone":"+02:00"},"email_id":"test"}}}'
    description: "Insert one event to existing Emails"

  # VALIDATED - same
  - sql: DELETE FROM emails_with_events WHERE (data ->> 'from') LIKE '%@yahoo.com'
    mongo:
      method: DELETE_MANY
      query:
        filter: '{"from": {"$regex": "^.*@yahoo\\.com$" }}'
    description: "Delete email by from email"

  #VALIDATED - same
  - sql: DELETE FROM emails_with_events WHERE id in (SELECT id FROM (SELECT id, json_array_elements(data -> 'events') -> 'user_agent' ->> 'platform' as device FROM emails_with_events) as platforms WHERE device = 'Android')
    mongo:
      method: DELETE_MANY
      query:
        filter: '{"events": {"$elemMatch": { "user_agent.platform": "Android" }}}'
    description: "Delete email by event platform - Android "

  # SQL DOES NOT WORK
#  - sql: UPDATE emails_with_events e SET data=jsonb_set(data::jsonb, '{events}'::text[], e2.events::jsonb) FROM (SELECT id, json_agg(singleevent) as events FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'event_type' as eventtype FROM emails_with_events) as eventarray WHERE eventtype::text != '"delivery"' GROUP BY id) e2 WHERE e.id = e2.id
#    mongo:
#      method: UPDATE_MANY
#      query:
#        filter: '{}'
#        value: '{"$pull": { "events": {"event_type": "delivery"}}}'
#    description: "Delete event from emails by event type - delivery"

  # VALIDATED - same
  - sql: UPDATE emails_with_events SET data=jsonb_set(data::jsonb, '{from}'::text[], '"test@test.com"'::jsonb) WHERE (data ->> 'from') LIKE '%@hotmail.com'
    mongo:
      method: UPDATE_MANY
      query:
        filter: '{"from": {"$regex": "^.*@hotmail\\.com$" }}'
        value: '{"$set": {"from": "test@test.com"}}'
    description: "Update email from field"

  # VALIDATED - same
  - sql: UPDATE emails_with_events e SET data=jsonb_set(data::jsonb, '{events}'::text[], e2.events::jsonb) FROM (SELECT id, json_agg(replaced) as events FROM (SELECT id, jsonb_set(singleevent::jsonb, '{user_agent, platform}'::text[], format('"%s"', coalesce((singleevent -> 'user_agent' ->> 'platform'), 'test'))::jsonb) as replaced FROM (SELECT id, json_array_elements(data -> 'events') as singleevent FROM emails_with_events) as replace) as new GROUP BY id) e2 WHERE e.id = e2.id
    mongo:
      method: UPDATE_MANY
      query:
        filter: '{"events": {"$elemMatch":{"user_agent.platform":{"$eq":null}}}}'
        value: '{"$set": {"events.$[event].user_agent.platform": "test"}}'
        arrayFilters: '[ { "event.user_agent.platform": { "$eq": null } } ]'
    description: "Update event device where null"

  #VALIDATED - diff
  - sql: UPDATE emails_with_events e SET data=jsonb_set(data::jsonb, '{events}'::text[], e2.events::jsonb) FROM (SELECT id, json_agg(singleevent) as events FROM (SELECT id, json_array_elements(data -> 'events') as singleevent, json_array_elements(data -> 'events') -> 'user_agent' -> 'platform' as device FROM emails_with_events) as eventarray WHERE device::text != '"Linux"' GROUP BY id) e2 WHERE e.id = e2.id
    mongo:
      method: UPDATE_MANY
      query:
        filter: '{}'
        value: '{"$pull": { "events": {"user_agent.platform": "Linux"}}}'
    description: "Delete event from emails by event platform - Linux"
